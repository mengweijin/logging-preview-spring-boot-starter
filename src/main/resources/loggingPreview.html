<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

    <head th:include="include::css"/>

    <body>
        <div id="index">
            <el-container>
                <el-header>
                    <el-menu
                            :default-active="activeIndex"
                            mode="horizontal"
                            @select="handleSelect"
                            background-color="#545c64"
                            text-color="#fff"
                            active-text-color="#ffd04b">
                        <el-menu-item index="0" style="color:red;font-weight:bold;">实时日志预览</el-menu-item>
                        <el-menu-item index="1">Log Path：<el-input v-model="logPath" clearable> </el-input></el-menu-item>
                    </el-menu>
                </el-header>

                <el-main>
                    <!-- 显示区。 Vue 默认会自动转义 HTML 内容，v-html 可以使其不发生转义-->
                    <div id="logContent" v-html="logContent" style="width:100%; height:600px; background-color: ghostwhite; overflow: auto;">
                    </div>

                    <!-- 操作栏 -->
                    <div style="text-align: center; margin-top: 10px;">
                        <el-row>
                            <el-checkbox v-model="autoBottom">Auto Scroll Down</el-checkbox>
                            <el-button @click="scrollToBottom()" type="primary" style="margin-left: 10px;">Scroll to Bottom</el-button>
                            <el-button @click="clearScreen()" type="primary" style="margin-left: 10px;">Clear Screen</el-button>
                        </el-row>
                    </div>
                </el-main>

                <el-footer><div th:include="include::el-footer"></div></el-footer>
            </el-container>
        </div>

        <div th:include="include::script"></div>

        <script>
        new Vue({
            el: '#index',
            data: function() {
                return {
                    activeIndex: '',
                    logContent: '',
                    autoBottom: false,
                    logPath: null
                }
            },
            methods: {
                handleSelect(key, keyPath) {
                    console.log(key, keyPath);
                },
                clearScreen() {
                    this.logContent = ''
                },
                scrollToBottom() {
                    let div = document.getElementById('logContent');
                    div.scrollTop = div.scrollHeight;
                },
                startWebSocket(ip, port) {
                    // websocket对象
                    let websocket = null;

                    let _this = this;

                    // 判断当前浏览器是否支持 WebSocket
                    if ('WebSocket' in window) {
                        websocket = new WebSocket("ws://" + ip + ":" + port + "/websocket/logging");
                    } else {
                        console.error("Your Browser not support WebSocket.");
                    }

                    // 连接发生错误的回调方法
                    websocket.onerror = function (e) {
                        console.error("WebSocket connect error.");
                    };

                    // 连接成功建立的回调方法
                    websocket.onopen = function () {
                        console.log("WebSocket connected.")
                    };

                    // 接收到消息的回调方法
                    websocket.onmessage = function (event) {
                        // 追加日志内容
                        if (event.data) {
                            _this.logContent = _this.logContent + event.data;
                            // 开启自动底部
                            if(_this.autoBottom) {
                                _this.scrollToBottom();
                            }
                        }
                    }

                    // 连接关闭的回调方法
                    websocket.onclose = function () {
                        console.log("WebSocket connect closed.")
                    };
                }
            },
            created: function() {
                let ip = '[[${ip}]]'
                let port = '[[${port}]]'
                this.startWebSocket(ip, port)
            }
        })
        </script>
    </body>
</html>